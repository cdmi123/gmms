<%- include('../partials/admin-header') %>

<div class="admin-wrapper">
    <%- include('../partials/admin-sidebar') %>
    
    <div class="admin-main-content">
        <nav class="admin-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle d-lg-none" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                <button class="sidebar-toggle d-none d-lg-block" onclick="toggleDesktopSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                <h5 class="navbar-title d-none d-md-block">Lucky Draws</h5>
            </div>
            
            <div class="navbar-right">
                <div class="navbar-date d-none d-sm-block">
                    <i class="bi bi-calendar3"></i>
                    <span><%= new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %></span>
                </div>
                <div class="navbar-user">
                    <div class="user-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="user-dropdown">
                        <a href="#" class="dropdown-item">
                            <i class="bi bi-person"></i>
                            <span>Profile</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/admin/logout" class="dropdown-item danger">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                    <div>
                        <h1 class="page-title">Lucky Draws</h1>
                        <p class="page-subtitle">Initialize and view history of lucky draws</p>
                    </div>
                    <div class="page-actions">
                        <% if (canStartDraw) { %>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#startDrawModal">
                                <i class="bi bi-gift-fill me-2"></i>
                                New Luck Draw
                            </button>
                        <% } else { %>
                            <button class="btn btn-secondary" disabled title="Complete all payments first">
                                <i class="bi bi-gift-fill me-2"></i>
                                New Luck Draw
                            </button>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Round</th>
                                <th>Lucky Winner</th>
                                <th class="d-none d-md-table-cell">Gold Weight</th>
                                <th class="text-end">Draw Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (draws && draws.length > 0) { %>
                                <% draws.forEach(draw => { %>
                                    <tr>
                                        <td>
                                            <span class="badge badge-primary">
                                                R-<%= draw.roundId ? draw.roundId.roundNumber : 'N/A' %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="stat-icon" style="width: 40px; height: 40px; background: #fef3c7; color: #f59e0b; margin: 0;">
                                                    <i class="bi bi-trophy-fill"></i>
                                                </div>
                                                <div class="fw-bold">
                                                    <%= draw.winnerId ? draw.winnerId.name : 'Deleted Member' %>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="fw-bold d-none d-md-table-cell">
                                            <%= draw.goldWeight %>g
                                        </td>
                                        <td class="text-muted text-end">
                                            <i class="bi bi-calendar-event me-2"></i>
                                            <%= draw.drawDate ? new Date(draw.drawDate).toLocaleDateString() : 'N/A' %>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4" class="text-center py-5">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">
                                                <i class="bi bi-dice-5"></i>
                                            </div>
                                            <div class="empty-state-title">No draws held yet</div>
                                            <div class="empty-state-text">Start a new draw to see records here</div>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Start Draw Modal -->
<div class="modal fade" id="startDrawModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Initialize Lucky Draw</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="drawForm" onsubmit="handleDrawSubmit(event)">
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <div class="stat-icon mx-auto mb-3" style="width: 80px; height: 80px; background: #dbeafe; color: #2563eb;">
                            <i class="bi bi-dice-5" style="font-size: 2rem;"></i>
                        </div>
                        <p class="text-muted">The system will randomly pick <b>Active Members</b> who have paid for the selected round.</p>
                    </div>
                    <div class="form-group mb-4 text-start">
                        <label class="form-label">Collection Round</label>
                        <select class="form-select" name="roundId" required>
                            <% if (rounds) { %>
                                <% rounds.filter(r => r.status === 'collecting').forEach(r => { %>
                                    <option value="<%= r._id %>">Round <%= r.roundNumber %> (‚Çπ<%= r.totalCollection.toLocaleString() %>)</option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-group text-start">
                                <label class="form-label">Gold Weight (g)</label>
                                <input type="number" step="0.01" class="form-control" name="goldWeight" placeholder="e.g. 10" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group text-start">
                                <label class="form-label">Number of Winners</label>
                                <input type="number" min="1" class="form-control" name="numberOfWinners" value="1" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="btnSpin">
                        <i class="bi bi-play-fill me-2"></i>
                        PICK WINNER NOW
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Suspense Reveal Modal -->
<div class="modal fade" id="suspenseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background: #1e293b; color: white;">
            <div class="modal-body p-5 d-flex flex-column align-items-center justify-content-center text-center" style="min-height: 500px;">
                <h2 class="text-primary fw-bold mb-5 display-5">
                    <i class="bi bi-stars me-2"></i>LUCKY DRAW<i class="bi bi-stars ms-2"></i>
                </h2>

                <div id="suspense-container" class="w-100">
                    <div class="name-shuffle-container">
                        <div class="shuffle-box">
                            <h1 class="display-2 fw-bold text-white mb-2" id="shuffling-name">Selecting...</h1>
                            <p class="fs-5 text-primary" id="shuffling-phone">Please wait</p>
                        </div>
                        <div class="shuffle-indicator mt-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; border-width: 0.25rem;"></div>
                        </div>
                    </div>
                </div>

                <div id="winner-reveal-container" class="d-none w-100">
                    <div class="display-1 mb-4">üèÜ</div>
                    <h5 class="text-muted text-uppercase fw-bold" style="letter-spacing: 2px;">Winner #<span id="winner-index">1</span></h5>
                    <h1 class="display-3 fw-bold text-white mb-2" id="winner-name">Name</h1>
                    <p class="fs-4 text-primary" id="winner-phone">Phone</p>
                </div>

                <div id="all-winners-list" class="d-none w-100 mt-4 text-start">
                    <h4 class="text-center mb-4 text-primary fw-bold">Draw Completed!</h4>
                    <div class="list-group list-group-flush rounded-lg overflow-hidden" id="winners-ul" style="background: rgba(255,255,255,0.05)">
                    </div>
                    <div class="text-center mt-5">
                        <button class="btn btn-primary btn-lg rounded-lg px-5" onclick="location.reload()">DONE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function handleDrawSubmit(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const startDrawModal = bootstrap.Modal.getInstance(document.getElementById('startDrawModal'));
        startDrawModal.hide();

        const suspenseModal = new bootstrap.Modal(document.getElementById('suspenseModal'));
        suspenseModal.show();

        const suspenseContainer = document.getElementById('suspense-container');
        const winnerReveal = document.getElementById('winner-reveal-container');
        const winnerNameEl = document.getElementById('winner-name');
        const winnerPhoneEl = document.getElementById('winner-phone');
        const winnerIndexEl = document.getElementById('winner-index');
        const allWinnersList = document.getElementById('all-winners-list');
        const winnersUl = document.getElementById('winners-ul');

        try {
            const response = await fetch('/admin/draws/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success && result.winners.length > 0) {
                const winners = result.winners;
                const allMembers = result.allMembers || [];

                for (let i = 0; i < winners.length; i++) {
                    const winner = winners[i];

                    // Show suspense container with name shuffling
                    suspenseContainer.classList.remove('d-none');
                    winnerReveal.classList.add('d-none');

                    const shufflingNameEl = document.getElementById('shuffling-name');
                    const shufflingPhoneEl = document.getElementById('shuffling-phone');

                    // Start name shuffling animation
                    let shuffleInterval;
                    let shuffleCount = 0;
                    const shuffleDuration = 5000; // 5 seconds
                    const shuffleSpeed = 100; // Change name every 100ms
                    const totalShuffles = shuffleDuration / shuffleSpeed;

                    // Create shuffled array excluding already selected winners
                    const availableMembers = allMembers.filter(m => {
                        const alreadyWon = winners.slice(0, i).some(w => w.winnerId.name === m.name);
                        return !alreadyWon;
                    });

                    // Shuffle animation function
                    const startShuffling = () => {
                        shuffleInterval = setInterval(() => {
                            if (shuffleCount < totalShuffles) {
                                // Randomly pick a name from available members
                                const randomIndex = Math.floor(Math.random() * availableMembers.length);
                                const randomMember = availableMembers[randomIndex];
                                
                                shufflingNameEl.textContent = randomMember.name;
                                shufflingPhoneEl.textContent = randomMember.phone;
                                
                                // Add fade effect
                                shufflingNameEl.style.opacity = '0.5';
                                shufflingPhoneEl.style.opacity = '0.5';
                                
                                setTimeout(() => {
                                    shufflingNameEl.style.opacity = '1';
                                    shufflingPhoneEl.style.opacity = '1';
                                }, 50);
                                
                                shuffleCount++;
                            } else {
                                // Stop shuffling and show the actual winner
                                clearInterval(shuffleInterval);
                                
                                // Final reveal with animation
                                shufflingNameEl.style.transition = 'all 0.5s ease';
                                shufflingPhoneEl.style.transition = 'all 0.5s ease';
                                shufflingNameEl.style.transform = 'scale(1.1)';
                                shufflingPhoneEl.style.transform = 'scale(1.1)';
                                
                                setTimeout(() => {
                                    shufflingNameEl.textContent = winner.winnerId.name;
                                    shufflingPhoneEl.textContent = winner.winnerId.phone;
                                    shufflingNameEl.style.transform = 'scale(1)';
                                    shufflingPhoneEl.style.transform = 'scale(1)';
                                }, 200);
                            }
                        }, shuffleSpeed);
                    };

                    // Start the shuffling animation
                    startShuffling();

                    // Wait for 5 seconds (shuffling duration)
                    await new Promise(r => setTimeout(r, shuffleDuration + 300));

                    // Clear interval if still running
                    if (shuffleInterval) {
                        clearInterval(shuffleInterval);
                    }

                    // Hide suspense and show winner
                    suspenseContainer.classList.add('d-none');
                    winnerReveal.classList.remove('d-none');

                    winnerIndexEl.innerText = i + 1;
                    winnerNameEl.innerText = winner.winnerId.name;
                    winnerPhoneEl.innerText = winner.winnerId.phone;

                    const li = document.createElement('div');
                    li.className = 'list-group-item bg-transparent text-white border-secondary p-3 d-flex justify-content-between align-items-center';
                    li.innerHTML = `<span><span class="text-muted me-3">#${i + 1}</span> ${winner.winnerId.name}</span> <span class="badge badge-primary">Winner</span>`;
                    winnersUl.appendChild(li);

                    if (i < winners.length - 1) {
                        await new Promise(r => setTimeout(r, 4000));
                    }
                }

                await new Promise(r => setTimeout(r, 2000));
                winnerReveal.classList.add('d-none');
                allWinnersList.classList.remove('d-none');
            } else {
                alert('Error: ' + (result.error || 'No winners returned'));
                location.reload();
            }
        } catch (err) {
            console.error(err);
            alert('An error occurred');
            location.reload();
        }
    }
</script>

<%- include('../partials/admin-footer') %>
