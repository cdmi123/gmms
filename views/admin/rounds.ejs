<%- include('../partials/header') %>
    <div class="admin-wrapper admin-light-body">
        <%- include('../partials/sidebar') %>
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

            <div class="admin-main-content">
                <!-- Mobile Nav -->
                <div class="admin-mobile-nav">
                    <div class="d-flex align-items-center">
                        <button class="btn p-0 me-3" onclick="toggleSidebar()">
                            <i class="bi bi-list fs-3"></i>
                        </button>
                        <h5 class="mb-0 fw-bold">GMMS Admin</h5>
                    </div>
                </div>

                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="text-blue fw-bold mb-0">Manage Collections</h2>
                            <p class="text-muted small">Manage payment rounds and collection status</p>
                        </div>
                        <button class="btn btn-blue shadow" data-bs-toggle="modal" data-bs-target="#createRoundModal">
                            <i class="bi bi-plus-circle-fill me-2"></i> <span class="d-none d-sm-inline">New Collection
                                Round</span>
                        </button>
                    </div>

                    <div class="admin-light-card mb-4">
                        <div class="table-responsive">
                            <table class="table admin-light-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Round #</th>
                                        <th class="d-none d-md-table-cell">Target</th>
                                        <th>Collected</th>
                                        <th>Status</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% rounds.forEach(round=> { %>
                                        <tr>
                                            <td class="fw-bold text-blue">Round <%= round.roundNumber %>
                                            </td>
                                            <td class="text-muted d-none d-md-table-cell">₹<%= round.targetAmount %>
                                            </td>
                                            <td class="text-blue fw-bold">₹<%= round.totalCollection %>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-<%= round.status === 'completed' ? 'success' : 'warning text-dark' %> rounded-pill">
                                                    <%= round.status %>
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-primary border-0"
                                                    data-bs-toggle="modal" data-bs-target="#payModal<%= round._id %>">
                                                    <i class="bi bi-cash-stack"></i> <span
                                                        class="d-none d-sm-inline ms-1">Payments</span>
                                                </button>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- Modals for each round -->
    <% rounds.forEach(round=> { %>
        <div class="modal fade" id="payModal<%= round._id %>" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-blue text-white">
                        <h5 class="modal-title fw-bold">Round <%= round.roundNumber %> Payments</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Member</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th class="text-end pe-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% payments.filter(p=> p.roundId.toString() ===
                                        round._id.toString()).forEach(payment => { %>
                                        <tr>
                                            <td class="ps-4 fw-bold text-blue">
                                                <%= payment.memberId.name %>
                                            </td>
                                            <td class="text-muted">₹<%= payment.amount %>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-<%= payment.status === 'paid' ? 'success' : 'warning text-dark' %> rounded-pill">
                                                    <%= payment.status %>
                                                </span>
                                            </td>
                                            <td class="text-end pe-4">
                                                <% if (payment.status==='pending' ) { %>
                                                    <button onclick="adminMarkPaid('<%= payment._id %>', this)"
                                                        class="btn btn-sm btn-success rounded-pill px-3">Mark
                                                        Paid</button>
                                                    <% } else { %>
                                                        <span class="text-success x-small fw-bold"><i
                                                                class="bi bi-check-circle-fill me-1"></i>
                                                            VERIFIED</span>
                                                        <% } %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% }) %>

            <!-- Create Round Modal -->
            <div class="modal fade" id="createRoundModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <form action="/admin/rounds/create" method="POST">
                            <div class="modal-header bg-blue text-white">
                                <h5 class="modal-title fw-bold">Start New Collection Round</h5>
                                <button type="button" class="btn-close btn-close-white"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="mb-4">
                                    <label class="form-label text-muted fw-bold">Round Number</label>
                                    <input type="number" class="form-control" name="roundNumber"
                                        value="<%= rounds.length + 1 %>" readonly>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label text-muted fw-bold">Total Collection Target (₹)</label>
                                    <input type="number" class="form-control" name="targetAmount"
                                        placeholder="e.g. 5000" required>
                                </div>
                            </div>
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-blue px-4">Initialize Round</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <%- include('../partials/footer') %>

                <script>
                    async function adminMarkPaid(paymentId, btnElement) {


                        // Visual feedback immediately
                        const originalText = btnElement.innerHTML;
                        btnElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                        btnElement.disabled = true;

                        try {
                            // Reuse the user API for now since it does exactly what we want (JSON response + socket emit)
                            // If we wanted to be strict, we'd duplicate this into an admin route, but for now this is efficient.
                            const response = await fetch('/user/api/pay', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ paymentId })
                            });

                            const result = await response.json();
                            if (result.success) {
                                // Update UI on success without reload
                                const parentTd = btnElement.closest('td');
                                // Find the status cell (previous sibling) to update badge
                                const tr = btnElement.closest('tr');
                                const statusTd = tr.children[2]; // Index 2 is status column

                                statusTd.innerHTML = '<span class="badge bg-success rounded-pill">paid</span>';

                                // Replace button with Verified text
                                parentTd.innerHTML = '<span class="text-success x-small fw-bold"><i class="bi bi-check-circle-fill me-1"></i> VERIFIED</span>';

                            } else {
                                alert('Error: ' + (result.error || 'Failed to update'));
                                btnElement.innerHTML = originalText;
                                btnElement.disabled = false;
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Network Error');
                            btnElement.innerHTML = originalText;
                            btnElement.disabled = false;
                        }
                    }
                </script>